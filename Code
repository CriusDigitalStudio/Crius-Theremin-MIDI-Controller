#include "Ultrasonic.h"           //Δηλώνουμε οτι θα χρησιμοποιήσουμε τη βιβλιοθήκη έτοιμου κώδικα "Ultrasonic"
#include <MIDI.h>                 //Δηλώνουμε οτι θα χρησιμοποιήσουμε τη βιβλιοθήκη έτοιμου κώδικα "MIDI"
MIDI_CREATE_DEFAULT_INSTANCE();   //Εντολή για τη συμβατότητα των MIDI εντολών : sendNoteOn και sendNoteOff με τη βιβλιοθήκη έτοιμου κώδικα MIDI

Ultrasonic ultrasonic(8, 7);      //Δηλώνουμε τα Pins του Arduino στα οποία έχουμε συνδέσει το Trigger και το Echo Pin αντίστοιχα

int midiMapped = 0;               //Ορίζουμε τη μεταβλητή της τρέχουσας τιμής MIDI "midiMapped" και της δίνουμε αρχική τιμή 0
int lastmidiMapped = 0;           //Ορίζουμε τη μεταβλητή της προηγούμενης τιμής MIDI "lastmidiMapped" και της δίνουμε αρχική τιμή 0


void setup() {
  Serial.begin(115200);           //Δηλώνουμε να ξεκινήσει η λειτουργία σειριακής επικοινωνίας "Serial.begin" με τη συσκευή που έχομε συνδέσει το Arduino
}


void loop() {
  float x  = ultrasonic.read(CM);                         //Διαβάζουμε την τιμή της απόστασης η οποία μετατρέπεται σε CM απο την εντολή "ultrasonic.read" της βιβλιοθήκης "Ultrasonic"
  delay (50);                                             //Βάζουμε μια μικρή καθυστέρηση στο "τρέξιμο" του κώδικα για να αποφύγουμε την "ασστάθεια" στο διάβασσμα των νοτών
  midiMapped = map(constrain(x, 5, 35), 5, 35, 48, 60);   //Μετατρέπουμε το ευρος τιμών απο 5-35 εκατοστά σε τιμές απο 48-60
  if (lastmidiMapped != midiMapped) {                     //Ελέγχουμε αν έχει αλλάξει η απόσσταση του χεριού
    MIDI.sendNoteOff(lastmidiMapped, 0, 1);               //στέλνουμε το ίδιο μύνημα Midi με το απο κάτω με τιμή 0 για την ένταση της νότας που αντιστοιχεί στην απόσταση που διαβάζει ο αισθητήρας
    MIDI.sendNoteOn(midiMapped, 127, 1);                  //στέλνουμε το μύνημα Midi με τον αριθμό της νότας που αντιστοιχεί στην απόσταση που διαβάζει ο αισθητήρας , την τιμή 127 που είναι η μέγιστη ένταση για να ακουστεί η νότα και το κανάλι Midi που στέλνουμε το μύνημα
    lastmidiMapped = midiMapped;                          //Ορίζουμε την προηγούμενη τιμή = με την τωρινή ώστε οταν διαβάσει άλλη τιμή να την αντικαταστήσει με την καινούρια
    delay(50);                                            //Βάζουμε μια μικρή καθυστέρηση στο "τρέξιμο" του κώδικα για να αποφύγουμε την "ασστάθεια" στο διάβασσμα των νοτών
  }
}
